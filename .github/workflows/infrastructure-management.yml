name: ğŸ—ï¸ Infrastructure Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - delete
          - list
        default: 'deploy'
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      confirm_delete:
        description: 'Type "DELETE" to confirm deletion (required for delete action)'
        required: false
        type: string
        default: ''

env:
  AWS_REGION: us-east-1

jobs:
  infrastructure:
    name: ${{ inputs.action == 'deploy' && 'ğŸš€ Deploy' || inputs.action == 'delete' && 'ğŸ—‘ï¸ Delete' || 'ğŸ“‹ List' }} Infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: âœ… Validate AWS Configuration
        run: |
          echo "ğŸ” Validating AWS credentials..."
          aws sts get-caller-identity
          echo "âœ… AWS credentials validated successfully!"

      - name: ğŸš€ Deploy Infrastructure
        if: inputs.action == 'deploy'
        run: |
          STACK_NAME="fintrax-${{ inputs.environment }}"
          TEMPLATE_FILE="infra/cloudformation/fintrax-infrastructure.yaml"
          PARAMETERS_FILE="infra/cloudformation/parameters-${{ inputs.environment }}.json"
          
          echo "ğŸ—ï¸ Deploying CloudFormation stack: $STACK_NAME"
          echo "ğŸ“‹ Environment: ${{ inputs.environment }}"
          echo "ğŸ“„ Template: $TEMPLATE_FILE"
          echo "âš™ï¸ Parameters: $PARAMETERS_FILE"
          
          # Check if parameters file exists
          if [ ! -f "$PARAMETERS_FILE" ]; then
            echo "âŒ ERROR: Parameters file not found: $PARAMETERS_FILE"
            exit 1
          fi
          
          # Check if stack exists
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" &> /dev/null; then
            echo "ğŸ”„ Stack exists. Updating..."
            aws cloudformation update-stack \
              --stack-name "$STACK_NAME" \
              --template-body file://"$TEMPLATE_FILE" \
              --parameters file://"$PARAMETERS_FILE" \
              --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
              --region ${{ env.AWS_REGION }}
            
            echo "â³ Waiting for stack update to complete..."
            aws cloudformation wait stack-update-complete \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }}
          else
            echo "ğŸ†• Stack does not exist. Creating..."
            aws cloudformation create-stack \
              --stack-name "$STACK_NAME" \
              --template-body file://"$TEMPLATE_FILE" \
              --parameters file://"$PARAMETERS_FILE" \
              --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
              --region ${{ env.AWS_REGION }}
            
            echo "â³ Waiting for stack creation to complete..."
            aws cloudformation wait stack-create-complete \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }}
          fi
          
          echo "âœ… Stack $STACK_NAME deployed successfully!"

      - name: ğŸ“‹ Get Stack Outputs
        if: inputs.action == 'deploy'
        run: |
          STACK_NAME="fintrax-${{ inputs.environment }}"
          echo "ğŸ“Š Stack Outputs for $STACK_NAME:"
          aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[*].[OutputKey,OutputValue,Description]' \
            --output table || echo "No outputs available"

      - name: ğŸ›¡ï¸ Validate Delete Confirmation
        if: inputs.action == 'delete'
        run: |
          if [ "${{ inputs.confirm_delete }}" != "DELETE" ]; then
            echo "âŒ ERROR: Delete confirmation required!"
            echo "Please type 'DELETE' in the confirm_delete field to proceed with deletion."
            exit 1
          fi
          echo "âœ… Delete confirmation validated"

      - name: ğŸ—‘ï¸ Delete Infrastructure
        if: inputs.action == 'delete'
        run: |
          STACK_NAME="fintrax-${{ inputs.environment }}"
          
          echo "ğŸ—‘ï¸ Deleting CloudFormation stack: $STACK_NAME"
          echo "âš ï¸ Environment: ${{ inputs.environment }}"
          
          # Check if stack exists
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" &> /dev/null; then
            echo "ğŸ”„ Stack exists. Proceeding with deletion..."
            
            # Delete the stack
            aws cloudformation delete-stack \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }}
            
            echo "â³ Waiting for stack deletion to complete..."
            aws cloudformation wait stack-delete-complete \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }}
            
            echo "âœ… Stack $STACK_NAME deleted successfully!"
          else
            echo "âš ï¸ Stack $STACK_NAME does not exist or was already deleted"
          fi

      - name: ğŸ“‹ List All Stacks
        if: inputs.action == 'list'
        run: |
          echo "ğŸ“‹ FinTrax CloudFormation Stacks:"
          aws cloudformation list-stacks \
            --stack-status-filter \
              CREATE_COMPLETE \
              UPDATE_COMPLETE \
              DELETE_FAILED \
              ROLLBACK_COMPLETE \
            --query 'StackSummaries[?starts_with(StackName, `fintrax-`)].{Name:StackName,Status:StackStatus,Created:CreationTime,Updated:LastUpdatedTime}' \
            --output table \
            --region ${{ env.AWS_REGION }} || echo "No stacks found"

      - name: ğŸ’° Cost Estimation (Deploy Only)
        if: inputs.action == 'deploy'
        run: |
          STACK_NAME="fintrax-${{ inputs.environment }}"
          echo "ğŸ’° Estimated Monthly Costs for ${{ inputs.environment }} environment:"
          echo "ğŸ“Š EKS Control Plane: ~$73/month"
          echo "ğŸ–¥ï¸ EC2 Nodes (t3.medium x2): ~$60/month"
          echo "ğŸ—„ï¸ RDS (db.t3.micro): ~$13/month"
          echo "âš–ï¸ Load Balancer: ~$16/month"
          echo "ğŸ“¦ Storage & Other: ~$10/month"
          echo "ğŸ’µ Total Estimated: ~$170/month"
          echo ""
          echo "ğŸ’¡ To minimize costs:"
          echo "   â€¢ Use Free Tier resources when possible"
          echo "   â€¢ Delete stacks when not in use"
          echo "   â€¢ Monitor AWS billing dashboard"

      - name: ğŸ¯ Next Steps
        if: inputs.action == 'deploy'
        run: |
          echo "ğŸ¯ Infrastructure deployed! Next steps:"
          echo "1. ğŸ”§ Update kubeconfig: aws eks update-kubeconfig --name fintrax-eks-${{ inputs.environment }} --region ${{ env.AWS_REGION }}"
          echo "2. ğŸš€ Deploy ArgoCD: kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml"
          echo "3. ğŸ“± Deploy applications via ArgoCD or GitOps workflows"
          echo "4. ğŸ” Monitor costs in AWS Console"

      - name: ğŸ“Š Deployment Summary
        if: always() && inputs.action != 'list'
        run: |
          echo "ğŸ“Š Deployment Summary:"
          echo "   ğŸ¯ Action: ${{ inputs.action }}"
          echo "   ğŸŒ Environment: ${{ inputs.environment }}"
          echo "   ğŸ“ Region: ${{ env.AWS_REGION }}"
          echo "   ğŸ“… Timestamp: $(date -u)"
          echo "   ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "   ğŸ”— Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
